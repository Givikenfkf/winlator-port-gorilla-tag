name: Build (download Harmony nupkg, extract DLL, build)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare lib folder
        run: |
          if(!(Test-Path lib)) { New-Item -ItemType Directory -Path lib } else { Write-Host "lib exists" }
        shell: powershell

      - name: Download HarmonyLib nupkg from NuGet
        run: |
          Write-Host "Downloading HarmonyLib nupkg..."
          Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/HarmonyLib/2.2.2" -OutFile harmony.nupkg
          Write-Host "Downloaded harmony.nupkg, extracting..."
          Expand-Archive -LiteralPath harmony.nupkg -DestinationPath harmony_pkg -Force
          # prefer net472 then netstandard2.0 then search
          if (Test-Path "harmony_pkg/lib/net472/HarmonyLib.dll") {
            Copy-Item -Path "harmony_pkg/lib/net472/HarmonyLib.dll" -Destination "lib/HarmonyLib.dll" -Force
          } elseif (Test-Path "harmony_pkg/lib/netstandard2.0/HarmonyLib.dll") {
            Copy-Item -Path "harmony_pkg/lib/netstandard2.0/HarmonyLib.dll" -Destination "lib/HarmonyLib.dll" -Force
          } else {
            $dll = Get-ChildItem -Path harmony_pkg -Recurse -Filter "HarmonyLib.dll" | Select-Object -First 1
            if ($dll) { Copy-Item -Path $dll.FullName -Destination "lib/HarmonyLib.dll" -Force }
            else { Write-Error "HarmonyLib.dll not found in package"; exit 1 }
          }
          Write-Host "lib contents:"
          Get-ChildItem -Path lib

      - name: (Optional) copy game / BepInEx DLLs
        run: |
          echo "If you need to provide UnityEngine.dll/Assembly-CSharp.dll/BepInEx.dll from secrets or release, do that here."
        shell: bash

      - name: Build project
        run: |
          dotnet build src/Content/GorillaTagModTemplateProject/GorillaTagModTemplateProject.csproj -c Release -o artifacts
        shell: bash

      - name: List artifacts
        run: dir artifacts
